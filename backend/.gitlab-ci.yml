# Backend CI/CD Pipeline
# GitLab Runner Tag: staging

stages:
  - build
  - test
  - build-docker
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  BACKEND_IMAGE_NAME: $CI_REGISTRY_IMAGE/backend
  SERVICE_DIR: backend

# Cache Maven dependencies for faster builds
.maven_cache: &maven_cache
  cache:
    key: backend-maven-$CI_COMMIT_REF_SLUG
    paths:
      - .m2/repository/
      - target/

# Backend Build Job
build:backend:
  stage: build
  tags:
    - staging
  image: maven:3.9.9-eclipse-temurin-21
  <<: *maven_cache
  script:
    - echo "Building Java backend application..."
    - mvn clean compile -B
  artifacts:
    paths:
      - target/classes/
      - target/*.jar
    expire_in: 1 hour
  only:
    changes:
      - backend/**/*
      - "*.gitlab-ci.yml"
    refs:
      - main
      - develop
      - merge_requests

# Backend Test Job
test:backend:
  stage: test
  tags:
    - staging
  image: maven:3.9.9-eclipse-temurin-21
  services:
    - name: postgres:15-alpine
      alias: postgres
  variables:
    POSTGRES_HOST: postgres
    POSTGRES_PORT: 5432
    POSTGRES_DB: test_ecommerce
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
  <<: *maven_cache
  script:
    - echo "Running backend unit tests..."
    - mvn test -B
    - echo "Running backend integration tests..."
    - mvn verify -B
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
      coverage_report:
        coverage_format: cobertura
        path: target/site/jacoco/jacoco.xml
    paths:
      - target/surefire-reports/
      - target/site/jacoco/
    expire_in: 1 week
  only:
    changes:
      - backend/**/*
      - "*.gitlab-ci.yml"
    refs:
      - main
      - develop
      - merge_requests

# Build Backend Docker Image
build-docker:backend:
  stage: build-docker
  tags:
    - staging
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building backend Docker image..."
    - |
      docker build \
        --tag $BACKEND_IMAGE_NAME:$CI_COMMIT_SHORT_SHA \
        --tag $BACKEND_IMAGE_NAME:latest \
        --tag $BACKEND_IMAGE_NAME:$CI_COMMIT_REF_SLUG \
        --file Dockerfile \
        .
    - echo "Pushing backend Docker image to registry..."
    - docker push $BACKEND_IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - docker push $BACKEND_IMAGE_NAME:latest
    - docker push $BACKEND_IMAGE_NAME:$CI_COMMIT_REF_SLUG
  after_script:
    - docker logout $CI_REGISTRY
  dependencies:
    - build:backend
    - test:backend
  only:
    changes:
      - backend/**/*
      - "*.gitlab-ci.yml"
    refs:
      - main
      - develop

# Deploy Backend to Staging
deploy:backend:staging:
  stage: deploy
  tags:
    - staging
  image: alpine:latest
  before_script:
    - apk add --no-cache curl docker-cli docker-compose kubectl
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Deploying backend to staging environment..."
    - |
      if [ -f ../docker-compose.yml ]; then
        echo "Using Docker Compose deployment..."
        cd ..
        # Update image tag in docker-compose.yml
        sed -i "s|image:.*backend.*|image: $BACKEND_IMAGE_NAME:$CI_COMMIT_SHORT_SHA|g" docker-compose.yml
        # Deploy using docker-compose
        docker-compose pull backend
        docker-compose up -d backend
        # Health check
        echo "Waiting for backend to be healthy..."
        sleep 30
        curl -f http://localhost:8080/actuator/health || exit 1
      elif [ -f ../k8s/backend/deployment.yaml ]; then
        echo "Using Kubernetes deployment..."
        cd ..
        # Update image in deployment.yaml
        sed -i "s|image:.*backend.*|image: $BACKEND_IMAGE_NAME:$CI_COMMIT_SHORT_SHA|g" k8s/backend/deployment.yaml
        # Apply Kubernetes deployment
        kubectl apply -f k8s/backend/deployment.yaml
        kubectl rollout status deployment/backend -n ecommerce
        # Health check via kubectl
        kubectl wait --for=condition=available --timeout=300s deployment/backend -n ecommerce
      else
        echo "No deployment configuration found!"
        exit 1
      fi
    - echo "Backend deployment completed successfully!"
  environment:
    name: staging/backend
    url: http://staging-backend.example.com:8080
  only:
    changes:
      - backend/**/*
      - "*.gitlab-ci.yml"
    refs:
      - main
      - develop
  when: on_success

# Rollback Backend (Manual)
rollback:backend:staging:
  stage: deploy
  tags:
    - staging
  image: alpine:latest
  before_script:
    - apk add --no-cache curl docker-cli docker-compose kubectl
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Rolling back backend deployment..."
    - |
      if [ -z "$ROLLBACK_IMAGE_TAG" ]; then
        echo "Error: ROLLBACK_IMAGE_TAG variable must be set"
        exit 1
      fi
      if [ -f ../docker-compose.yml ]; then
        cd ..
        sed -i "s|image:.*backend.*|image: $BACKEND_IMAGE_NAME:$ROLLBACK_IMAGE_TAG|g" docker-compose.yml
        docker-compose up -d backend
      elif [ -f ../k8s/backend/deployment.yaml ]; then
        cd ..
        sed -i "s|image:.*backend.*|image: $BACKEND_IMAGE_NAME:$ROLLBACK_IMAGE_TAG|g" k8s/backend/deployment.yaml
        kubectl apply -f k8s/backend/deployment.yaml
        kubectl rollout status deployment/backend -n ecommerce
      fi
    - echo "Backend rollback completed!"
  environment:
    name: staging/backend
    action: rollback
  when: manual
  only:
    changes:
      - backend/**/*
      - "*.gitlab-ci.yml"
    refs:
      - main
      - develop

